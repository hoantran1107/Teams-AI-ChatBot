// This file is automatically generated by Teams Toolkit.
// The teamsfx tasks defined in this file require Teams Toolkit version >= 5.0.0.
// See https://aka.ms/teamsfx-tasks for details on how to customize each task.
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "docker-debug-build-and-run",
      "type": "shell",
      "command": "docker build -t ifd-cpb-python-ai-debug -f Dockerfile.debug . ; docker run --rm -p 5000:5000 -p 5678:5678 --env-file .env.local --env-file env/.env.local -v \"${workspaceFolder}:/app\" ifd-cpb-python-ai-debug",
      "isBackground": true,
      "problemMatcher": {
        "pattern": {
          "regexp": ".",
          "file": 1,
          "location": 2,
          "message": 3
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": ".",
          "endsPattern": "Waiting for client to connect"
        }
      }
    },
    {
      "label": "Run Python Dev",
      "type": "shell",
      "command": "python main.py dotenv_config_path=.env.local",
      "group": "build"
    },
    {
      // Check all required prerequisites.
      // See https://aka.ms/teamsfx-tasks/check-prerequisites to know the details and how to customize the args.
      "label": "Validate prerequisites (Test Tool)",
      "type": "teamsfx",
      "command": "debug-check-prerequisites",
      "args": {
        "prerequisites": [
          "nodejs", // Check if Node.js is installed and the version is >= 12.
          "portOccupancy" // Validate available ports to ensure those debug ones are not occupied.
        ],
        "portOccupancy": [
          5000, // app service port
          56150 // test tool port
        ]
      }
    },
    {
      // Build project.
      // See https://aka.ms/teamsfx-tasks/deploy to know the details and how to customize the args.
      "label": "Deploy (Test Tool)",
      "dependsOn": [
        "Validate prerequisites (Test Tool)"
      ],
      "type": "teamsfx",
      "command": "deploy",
      "args": {
        "env": "testtool"
      }
    },
    {
      "label": "Start Teams App Locally",
      "dependsOn": [
        "Validate prerequisites",
        "Start local tunnel",
        "Provision",
        "Deploy"
      ],
      "dependsOrder": "sequence"
    },
    {
      // Check all required prerequisites.
      // See https://aka.ms/teamsfx-tasks/check-prerequisites to know the details and how to customize the args.
      "label": "Validate prerequisites",
      "type": "teamsfx",
      "command": "debug-check-prerequisites",
      "args": {
        "prerequisites": [
          "m365Account", // Sign-in prompt for Microsoft 365 account, then validate if the account enables the sideloading permission.
          "portOccupancy" // Validate available ports to ensure those debug ones are not occupied.
        ],
        "portOccupancy": [
          5000 // app service port
        ]
      }
    },
    {
      // Start the local tunnel service to forward public URL to local port and inspect traffic.
      // See https://aka.ms/teamsfx-tasks/local-tunnel for the detailed args definitions.
      "label": "Start local tunnel",
      "type": "teamsfx",
      "command": "debug-start-local-tunnel",
      "args": {
        "type": "dev-tunnel",
        "ports": [
          {
            "portNumber": 5000,
            "protocol": "http",
            "access": "public",
            "writeToEnvironmentFile": {
              "endpoint": "BOT_ENDPOINT", // output tunnel endpoint as BOT_ENDPOINT
              "domain": "BOT_DOMAIN" // output tunnel domain as BOT_DOMAIN
            }
          }
        ],
        "env": "local"
      },
      "isBackground": true,
      "problemMatcher": "$teamsfx-local-tunnel-watch"
    },
    {
      // Create the debug resources.
      // See https://aka.ms/teamsfx-tasks/provision to know the details and how to customize the args.
      "label": "Provision",
      "type": "teamsfx",
      "command": "provision",
      "args": {
        "env": "local"
      }
    },
    {
      // Build project.
      // See https://aka.ms/teamsfx-tasks/deploy to know the details and how to customize the args.
      "label": "Deploy",
      "type": "teamsfx",
      "command": "deploy",
      "args": {
        "env": "local"
      }
    },
    {
      "label": "Start Teams App in Desktop Client",
      "dependsOn": [
        "Validate prerequisites",
        "Start local tunnel",
        "Provision",
        "Deploy",
        "Start desktop client"
      ],
      "dependsOrder": "sequence"
    },
    {
      "label": "Start desktop client",
      "type": "teamsfx",
      "command": "launch-desktop-client",
      "args": {
        "url": "teams.microsoft.com/l/app/${{local:TEAMS_APP_ID}}?installAppPackage=true"
      }
    },
    {
      "label": "Start Teams App in Desktop Client (Remote)",
      "type": "teamsfx",
      "command": "launch-desktop-client",
      "args": {
        "url": "teams.microsoft.com/l/app/${{TEAMS_APP_ID}}?installAppPackage=true"
      }
    }
  ]
}